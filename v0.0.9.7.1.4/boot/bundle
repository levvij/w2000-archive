#!/bin/sh

echo -n "release codename: "
read codename

echo -n "root query: "
read root

echo "generating autogen files"
echo "//AUTOGENERATED\n// DO NOT EDIT\nconfig.injectedQuery = '?$root';" > fs/c/windows/ime/gen/iquery.js
echo ?$root > fs/c/windows/ime/gen/iquery.prop

echo "//AUTOGENERATED\n// DO NOT EDIT\nconfig.rc = '$release';" > fs/c/windows/ime/gen/rc.js
echo $release > fs/c/windows/ime/gen/rc.prop

echo "//AUTOGENERATED\n// DO NOT EDIT\nconfig.beta = false;" > fs/c/windows/ime/gen/beta.js
echo false > fs/c/windows/ime/gen/beta.prop

echo "//AUTOGENERATED\n// DO NOT EDIT\nconfig.buildTime = new Date(`date +'%s'`000);" > fs/c/windows/ime/gen/buildTime.js
echo `date +'%s'`000 > fs/c/windows/ime/gen/buildTime.prop

echo "//AUTOGENERATED\n// DO NOT EDIT\nconfig.fs.providers.find(p => p.type == 'rrsp').ray = 'fs/ray';" > fs/c/windows/ime/gen/rrsp.js

echo "rendering index"
php index.php > index.html
echo 

echo "rendering ray"
cd fs
php ray.php > ray
cd ..

echo "copying files"
mkdir ../win-bundles/$codename
mkdir ../win-bundles/$codename/boot
cp -r . ../win-bundles/$codename/boot

./reset

cd ../win-bundles/$codename/boot

echo "removing php"
rm fs/ray.php
rm index.php
rm bundle
rm reset
rm deploy
rm test
rm tests -r
rm changes

echo "compressing files"
zip -r ../$codename.zip . > /dev/null

echo "creating index"
echo "<script>location.href='boot/'</script>" > ../index.html
#!/bin/sh

echo -n "last "
cat changes | head -n 1

echo -n "new version name: "
read version

content=`cat changes`
echo "version $version\n* \n\n$content" > changes
vi +2 changes

echo "generating autogen files"
echo "//AUTOGENERATED\n// DO NOT EDIT\nconfig.version = '$version';" > fs/c/windows/ime/gen/version.js
echo -n $version > fs/c/windows/ime/gen/version.prop

echo "//AUTOGENERATED\n// DO NOT EDIT\nconfig.beta = false;" > fs/c/windows/ime/gen/beta.js
echo -n false > fs/c/windows/ime/gen/beta.prop

echo "//AUTOGENERATED\n// DO NOT EDIT\nconfig.buildTime = new Date(`date +'%s'`000);" > fs/c/windows/ime/gen/buildTime.js
echo -n `date +'%s'`000 > fs/c/windows/ime/gen/buildTime.prop

echo "//AUTOGENERATED\n// DO NOT EDIT\nconfig.fs.providers.find(p => p.type == 'rrsp').ray = 'fs/ray';" > fs/c/windows/ime/gen/rrsp.js

echo "rendering index.php"
php index.php > index.html

echo "rendering ray.php"
cd fs
php ray.php > ray
cd ..

echo "running tests"
./test

echo "copying files"
mkdir ../win-versions/v$version/boot
cp -r . ../win-versions/v$version/boot

echo "compressing files"
zip -r ../win-versions/v$version/release.zip . > /dev/null

./reset
